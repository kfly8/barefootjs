/**
 * Build script for the BarefootJS site (landing page + documentation).
 *
 * Generates:
 * - dist/content.json (bundled markdown from docs/core/)
 * - dist/components/{Component}.tsx (Marked Template)
 * - dist/components/{Component}-{hash}.js (Client JS)
 * - dist/components/barefoot.js (Runtime)
 * - dist/components/manifest.json
 * - dist/uno.css (UnoCSS output)
 * - dist/static/globals.css (tokens.css + globals.css + landing.css concatenated)
 * - dist/static/uno.css
 * - dist/static/components/ (client JS for browser)
 * - dist/static/logos/ (framework logos for LP)
 * - dist/static/snippets/ (code snippet files for LP)
 */

import { compileJSX } from '@barefootjs/jsx'
import { HonoAdapter } from '@barefootjs/hono/adapter'
import { mkdir, readdir } from 'node:fs/promises'
import { dirname, resolve, join, relative } from 'node:path'
import { loadContentFromDisk } from './lib/content-loader'
import {
  hasUseClientDirective,
  discoverComponentFiles,
  generateHash,
  addScriptCollection,
} from '../../packages/cli/src/lib/build'

const ROOT_DIR = dirname(import.meta.path)
const CONTENT_DIR = resolve(ROOT_DIR, '../../docs/core')
const DIST_DIR = resolve(ROOT_DIR, 'dist')
const DIST_COMPONENTS_DIR = resolve(DIST_DIR, 'components')
const DIST_STATIC_DIR = resolve(DIST_DIR, 'static')
const DOM_PKG_DIR = resolve(ROOT_DIR, '../../packages/dom')
const SHARED_DIR = resolve(ROOT_DIR, '../shared')
const COMPONENTS_DIR = resolve(ROOT_DIR, 'components')
const LANDING_COMPONENTS_DIR = resolve(ROOT_DIR, 'landing/components')

console.log('Building BarefootJS site...\n')

await mkdir(DIST_COMPONENTS_DIR, { recursive: true })
await mkdir(DIST_STATIC_DIR, { recursive: true })

// ── 1. Bundle markdown content ────────────────────────────────
const { pages, content } = await loadContentFromDisk(CONTENT_DIR)
await Bun.write(resolve(DIST_DIR, 'content.json'), JSON.stringify(content))
console.log(`Bundled: ${pages.length} pages → dist/content.json`)

// ── 2. Build and copy barefoot.js runtime ─────────────────────
const barefootFileName = 'barefoot.js'
const domDistFile = resolve(DOM_PKG_DIR, 'dist/index.js')

if (!await Bun.file(domDistFile).exists()) {
  console.log('Building @barefootjs/dom...')
  const proc = Bun.spawn(['bun', 'run', 'build'], { cwd: DOM_PKG_DIR })
  await proc.exited
}

await Bun.write(
  resolve(DIST_COMPONENTS_DIR, barefootFileName),
  Bun.file(domDistFile)
)
console.log(`Generated: dist/components/${barefootFileName}`)

// ── 3. Compile "use client" components ────────────────────────

// Manifest
const manifest: Record<string, { clientJs?: string; markedTemplate: string }> = {
  '__barefoot__': { markedTemplate: '', clientJs: `components/${barefootFileName}` }
}

const adapter = new HonoAdapter()

// Discover components from local, shared, and landing dirs
const localComponentFiles = await discoverComponentFiles(COMPONENTS_DIR)
const sharedComponentFiles = await discoverComponentFiles(resolve(SHARED_DIR, 'components'))
const landingComponentFiles = await discoverComponentFiles(LANDING_COMPONENTS_DIR)
const componentFiles = [...localComponentFiles, ...sharedComponentFiles, ...landingComponentFiles]

for (const entryPath of componentFiles) {
  const sourceContent = await Bun.file(entryPath).text()
  if (!hasUseClientDirective(sourceContent)) continue

  const result = await compileJSX(entryPath, async (path) => {
    return await Bun.file(path).text()
  }, { adapter })

  const errors = result.errors.filter(e => e.severity === 'error')
  const warnings = result.errors.filter(e => e.severity === 'warning')

  if (warnings.length > 0) {
    console.warn(`Warnings compiling ${entryPath}:`)
    for (const warning of warnings) console.warn(`  ${warning.message}`)
  }

  if (errors.length > 0) {
    console.error(`Errors compiling ${entryPath}:`)
    for (const error of errors) console.error(`  ${error.message}`)
    continue
  }

  // Determine rootDir based on source location
  const isSharedComponent = entryPath.startsWith(resolve(SHARED_DIR, 'components'))
  const isLandingComponent = entryPath.startsWith(LANDING_COMPONENTS_DIR)
  const rootDir = isSharedComponent
    ? resolve(SHARED_DIR, 'components')
    : isLandingComponent
    ? LANDING_COMPONENTS_DIR
    : COMPONENTS_DIR

  const relativePath = relative(rootDir, entryPath)
  const dirPath = dirname(relativePath)
  const baseFileName = relativePath.split('/').pop()!
  const baseNameNoExt = baseFileName.replace('.tsx', '')

  const outputDir = dirPath === '.' ? DIST_COMPONENTS_DIR : resolve(DIST_COMPONENTS_DIR, dirPath)
  await mkdir(outputDir, { recursive: true })

  let markedJsxContent = ''
  let clientJsContent = ''

  for (const file of result.files) {
    if (file.type === 'markedTemplate') markedJsxContent = file.content
    else if (file.type === 'clientJs') clientJsContent = file.content
  }

  if (!markedJsxContent && !clientJsContent) {
    let transformedSource = sourceContent.replace(/^['"]use client['"];?\s*/m, '')
    await Bun.write(resolve(outputDir, baseFileName), transformedSource)
    console.log(`Generated: dist/components/${relativePath}`)
    manifest[baseNameNoExt] = { markedTemplate: `components/${relativePath}` }
    continue
  }

  if (markedJsxContent && !clientJsContent) {
    await Bun.write(resolve(outputDir, baseFileName), markedJsxContent)
    console.log(`Generated: dist/components/${relativePath}`)
    manifest[baseNameNoExt] = { markedTemplate: `components/${relativePath}` }
    continue
  }

  const hasClientJs = clientJsContent.length > 0
  const hash = generateHash(clientJsContent || markedJsxContent)
  const clientJsFilename = `${baseNameNoExt}-${hash}.js`

  if (hasClientJs) {
    await Bun.write(resolve(outputDir, clientJsFilename), clientJsContent)
    const clientJsRelativePath = dirPath === '.' ? clientJsFilename : `${dirPath}/${clientJsFilename}`
    console.log(`Generated: dist/components/${clientJsRelativePath}`)
  }

  if (markedJsxContent && hasClientJs) {
    const clientJsRelPath = dirPath === '.' ? clientJsFilename : `${dirPath}/${clientJsFilename}`
    const wrappedContent = addScriptCollection(markedJsxContent, baseNameNoExt, clientJsRelPath)
    await Bun.write(resolve(outputDir, baseFileName), wrappedContent)
    console.log(`Generated: dist/components/${relativePath}`)
  } else if (markedJsxContent) {
    await Bun.write(resolve(outputDir, baseFileName), markedJsxContent)
    console.log(`Generated: dist/components/${relativePath}`)
  }

  const componentName = baseNameNoExt
  const markedJsxPath = `components/${relativePath}`
  const clientJsPath = hasClientJs
    ? `components/${dirPath === '.' ? clientJsFilename : `${dirPath}/${clientJsFilename}`}`
    : undefined

  manifest[componentName] = {
    markedTemplate: markedJsxPath,
    clientJs: clientJsPath,
  }
}

// Output manifest
await Bun.write(resolve(DIST_COMPONENTS_DIR, 'manifest.json'), JSON.stringify(manifest, null, 2))
console.log('Generated: dist/components/manifest.json')

// Generate index.ts for re-exporting all compiled components
async function collectExports(dir: string, prefix: string = ''): Promise<string[]> {
  const exports: string[] = []
  const entries = await readdir(dir, { withFileTypes: true }).catch(() => [])
  for (const entry of entries) {
    const fullPath = join(dir, entry.name)
    if (entry.isDirectory()) {
      exports.push(...await collectExports(fullPath, `${prefix}${entry.name}/`))
    } else if (entry.name.endsWith('.tsx')) {
      const baseName = entry.name.replace('.tsx', '')
      const content = await Bun.file(fullPath).text()
      const exportMatches = content.matchAll(/export\s+(?:function|const)\s+(\w+)/g)
      for (const match of exportMatches) {
        exports.push(`export { ${match[1]} } from './${prefix}${baseName}'`)
      }
    }
  }
  return exports
}

const componentExports = await collectExports(DIST_COMPONENTS_DIR)
if (componentExports.length > 0) {
  await Bun.write(resolve(DIST_COMPONENTS_DIR, 'index.ts'), componentExports.join('\n') + '\n')
  console.log('Generated: dist/components/index.ts')
}

// ── 4. CSS: Generate tokens from JSON + globals.css + landing.css ─
const { loadTokens, generateCSS } = await import('../shared/tokens/index')
const baseTokens = await loadTokens(resolve(SHARED_DIR, 'tokens/tokens.json'))
const tokensCSS = generateCSS(baseTokens)
const globalsCSS = await Bun.file(resolve(ROOT_DIR, 'styles/globals.css')).text()
const landingCSS = await Bun.file(resolve(ROOT_DIR, 'styles/landing.css')).text()
const combinedCSS = tokensCSS + '\n' + globalsCSS + '\n' + landingCSS
await Bun.write(resolve(DIST_DIR, 'globals.css'), combinedCSS)
await Bun.write(resolve(DIST_STATIC_DIR, 'globals.css'), combinedCSS)
console.log('Generated: dist/static/globals.css (tokens + globals + landing)')

// ── 5. Generate UnoCSS ───────────────────────────────────────
console.log('\nGenerating UnoCSS...')
const unoProc = Bun.spawn(
  ['bunx', 'unocss', './renderer.tsx', './landing/**/*.tsx', './components/**/*.tsx', './dist/**/*.tsx', '../shared/components/**/*.tsx', '-o', 'dist/uno.css'],
  { cwd: ROOT_DIR, stdout: 'inherit', stderr: 'inherit' }
)
await unoProc.exited
await Bun.write(resolve(DIST_STATIC_DIR, 'uno.css'), Bun.file(resolve(DIST_DIR, 'uno.css')))
console.log('Generated: dist/static/uno.css')

// ── 6. Copy icon files ───────────────────────────────────────
const IMAGES_DIR = resolve(ROOT_DIR, '../../images/logo')
const icon32 = resolve(IMAGES_DIR, 'icon-32.png')
const icon64 = resolve(IMAGES_DIR, 'icon-64.png')

if (await Bun.file(icon32).exists()) {
  await Bun.write(resolve(DIST_DIR, 'icon-32.png'), Bun.file(icon32))
  await Bun.write(resolve(DIST_STATIC_DIR, 'icon-32.png'), Bun.file(icon32))
  await Bun.write(resolve(DIST_DIR, 'favicon.ico'), Bun.file(icon32))
  console.log('Copied: dist/icon-32.png, dist/static/icon-32.png, dist/favicon.ico')
}
if (await Bun.file(icon64).exists()) {
  await Bun.write(resolve(DIST_DIR, 'icon-64.png'), Bun.file(icon64))
  await Bun.write(resolve(DIST_STATIC_DIR, 'icon-64.png'), Bun.file(icon64))
  console.log('Copied: dist/icon-64.png, dist/static/icon-64.png')
}

// ── 7. Copy .ts modules from landing/components (non-component modules) ──
async function copyTsModules(srcDir: string, destDir: string): Promise<void> {
  const entries = await readdir(srcDir, { withFileTypes: true }).catch(() => [])
  for (const entry of entries) {
    const srcPath = join(srcDir, entry.name)
    const destPath = join(destDir, entry.name)
    if (entry.isDirectory()) {
      await mkdir(destPath, { recursive: true })
      await copyTsModules(srcPath, destPath)
    } else if ((entry.name.endsWith('.ts') || entry.name.endsWith('.js')) && !entry.name.endsWith('.d.ts')) {
      await Bun.write(destPath, Bun.file(srcPath))
      console.log(`Copied: dist/components/${relative(DIST_COMPONENTS_DIR, destPath)}`)
    }
  }
}
await copyTsModules(LANDING_COMPONENTS_DIR, DIST_COMPONENTS_DIR)

// ── 8. Copy components/ to static/components/ ────────────────
async function copyDir(src: string, dest: string) {
  await mkdir(dest, { recursive: true })
  const entries = await readdir(src, { withFileTypes: true }).catch(() => [])
  for (const entry of entries) {
    const srcPath = join(src, entry.name)
    const destPath = join(dest, entry.name)
    if (entry.isDirectory()) {
      await copyDir(srcPath, destPath)
    } else {
      await Bun.write(destPath, Bun.file(srcPath))
    }
  }
}
await copyDir(DIST_COMPONENTS_DIR, resolve(DIST_STATIC_DIR, 'components'))
console.log('Copied: dist/static/components/')

// ── 9. Copy LP assets (snippets + logos) ──────────────────────
const SNIPPETS_SRC = resolve(ROOT_DIR, 'public/static/snippets')
const SNIPPETS_DEST = resolve(DIST_STATIC_DIR, 'snippets')
await mkdir(SNIPPETS_DEST, { recursive: true })
const snippetFiles = await readdir(SNIPPETS_SRC).catch(() => [] as string[])
for (const file of snippetFiles) {
  await Bun.write(resolve(SNIPPETS_DEST, file), Bun.file(resolve(SNIPPETS_SRC, file)))
}
if (snippetFiles.length > 0) {
  console.log(`Copied: dist/static/snippets/ (${snippetFiles.length} files)`)
}

const LOGOS_SRC = resolve(ROOT_DIR, 'assets/logos')
const DIST_LOGOS_DIR = resolve(DIST_DIR, 'logos')
const DIST_STATIC_LOGOS_DIR = resolve(DIST_STATIC_DIR, 'logos')
await mkdir(DIST_LOGOS_DIR, { recursive: true })
await mkdir(DIST_STATIC_LOGOS_DIR, { recursive: true })
const logoFiles = await readdir(LOGOS_SRC).catch(() => [] as string[])
for (const file of logoFiles) {
  if (file.endsWith('.svg')) {
    await Bun.write(resolve(DIST_LOGOS_DIR, file), Bun.file(resolve(LOGOS_SRC, file)))
    await Bun.write(resolve(DIST_STATIC_LOGOS_DIR, file), Bun.file(resolve(LOGOS_SRC, file)))
  }
}
if (logoFiles.length > 0) {
  console.log(`Copied: dist/logos/, dist/static/logos/ (${logoFiles.length} files)`)
}

console.log('\nBuild complete!')
